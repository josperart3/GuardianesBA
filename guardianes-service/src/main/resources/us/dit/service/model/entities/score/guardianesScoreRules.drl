package us.dit.service.model.entities.score

import java.lang.Math
import java.time.temporal.ChronoUnit
import us.dit.service.model.entities.Doctor
import us.dit.service.model.entities.ShiftAssignment
import us.dit.service.model.entities.DayConfiguration
import org.optaplanner.core.api.score.buildin.hardsoft.HardSoftScoreHolder

global HardSoftScoreHolder scoreHolder

dialect "mvel"

// ============================================================================
// HARD CONSTRAINTS
// ============================================================================

rule "Every shift must have a doctor"
    when
        $config : GuardianesConstraintConfiguration()
        ShiftAssignment( doctor == null )
    then
        scoreHolder.addHardConstraintMatch(kcontext, - $config.getEveryShiftAssigned().getHardScore());
end

rule "Doctor eligibility for Guardias"
    when
        $config : GuardianesConstraintConfiguration()
        ShiftAssignment(
            doctor != null,
            shift.shiftType == "GUARDIA",
            doctor.shiftConfiguration.doesCycleShifts == false
        )
    then
        scoreHolder.addHardConstraintMatch(kcontext, - $config.getEligibilityCycle().getHardScore());
end

rule "Holidays for a doctor"
    when
        $config : GuardianesConstraintConfiguration()
        ShiftAssignment(
            $doc : doctor != null,
            $date : dayConfiguration.date
        )
        eval($doc.getAbsence() != null && $doc.getAbsence().isAbsentOn($date))
    then
        scoreHolder.addHardConstraintMatch(kcontext, - $config.getHolidays().getHardScore());
end

rule "Incompatible: Consulta is exclusive"
    when
        $config : GuardianesConstraintConfiguration()
        $d : Doctor()
        $day : DayConfiguration()
        $a1 : ShiftAssignment(doctor == $d, dayConfiguration == $day, shift.shiftType == "CONSULTA")
        exists ShiftAssignment(doctor == $d, dayConfiguration == $day, this != $a1)
    then
        scoreHolder.addHardConstraintMatch(kcontext, - $config.getIncompatibleConsulta().getHardScore());
end

rule "Incompatible: No duplicate types"
    when
        $config : GuardianesConstraintConfiguration()
        $d : Doctor()
        $day : DayConfiguration()
        $a1 : ShiftAssignment(doctor == $d, dayConfiguration == $day, $type : shift.shiftType)
        $a2 : ShiftAssignment(doctor == $d, dayConfiguration == $day, this != $a1, shift.shiftType == $type)
        eval($a1.getId() < $a2.getId())
    then
        scoreHolder.addHardConstraintMatch(kcontext, - $config.getIncompatibleDuplicates().getHardScore());
end

rule "Linking: Shifts only when Cycle Shifts"
    when
        $config : GuardianesConstraintConfiguration()
        $doc : Doctor(shiftConfiguration.hasShiftsOnlyWhenCycleShifts == true)
        // Tiene TARDE
        $tarde : ShiftAssignment(
            doctor == $doc, 
            shift.shiftType == "TARDE",
            $day : dayConfiguration
        )
        // NO tiene GUARDIA
        not ShiftAssignment(
            doctor == $doc, 
            dayConfiguration == $day, 
            shift.shiftType == "GUARDIA"
        )
    then
        scoreHolder.addHardConstraintMatch(kcontext, - $config.getConditionalShifts().getHardScore());
end

rule "Doctor Max Shifts (Cont. Asist)"
    when
        $config : GuardianesConstraintConfiguration()
        $doc : Doctor($max : shiftConfiguration.maxShifts)
        $count : Number(intValue > $max) from accumulate(
            ShiftAssignment(doctor == $doc, shift.shiftType == "TARDE"),
            count()
        )
    then
        int penalization = $count.intValue() - $max;
        scoreHolder.addHardConstraintMatch(kcontext, - ($config.getDoctorMaxShifts().getHardScore() * penalization));
end

// ESTA ES LA REGLA QUE DABA EL ERROR DE SINCRONIZACIÓN
// Asegúrate de que el nombre coincide con DOCTOR_MIN_SHIFTS_HARD en Java
rule "Doctor Min Shifts Hard (Cont. Asist)"
    when
        $config : GuardianesConstraintConfiguration()
        $doc : Doctor($min : shiftConfiguration.minShifts)
        $count : Number(intValue < $min) from accumulate(
            ShiftAssignment(doctor == $doc, shift.shiftType == "TARDE"),
            count()
        )
    then
        int missing = $min - $count.intValue();
        scoreHolder.addHardConstraintMatch(kcontext, - ($config.getDoctorMinShiftsHard().getHardScore() * missing));
end

rule "Strict Consultations Count"
    when
        $config : GuardianesConstraintConfiguration()
        $doc : Doctor($expected : shiftConfiguration.numConsultations, $expected > 0)
        $count : Number() from accumulate(
            ShiftAssignment(doctor == $doc, shift.shiftType == "CONSULTA"),
            count()
        )
        eval($count.intValue() != $expected)
    then
        int diff = Math.abs($count.intValue() - $expected);
        scoreHolder.addHardConstraintMatch(kcontext, - ($config.getDoctorSpecificConsultations().getHardScore() * diff));
end


// ============================================================================
// SOFT CONSTRAINTS
// ============================================================================

rule "Fairness in Guardias"
    when
        $config : GuardianesConstraintConfiguration()
        $doc : Doctor(shiftConfiguration.doesCycleShifts == true)
        $count : Number() from accumulate(
            ShiftAssignment(doctor == $doc, shift.shiftType == "GUARDIA"),
            count()
        )
    then
        int penalization = $count.intValue() * $count.intValue();
        scoreHolder.addSoftConstraintMatch(kcontext, - ($config.getFairnessGuardias().getSoftScore() * penalization));
end

rule "Minimum days between Guardias"
    when
        $config : GuardianesConstraintConfiguration()
        $a1 : ShiftAssignment($d : doctor, shift.shiftType == "GUARDIA", $date1 : dayConfiguration.date, $id1 : id)
        $a2 : ShiftAssignment(doctor == $d, shift.shiftType == "GUARDIA", $date2 : dayConfiguration.date, id > $id1)
        eval(Math.abs(ChronoUnit.DAYS.between($date1, $date2)) < 3)
    then
        scoreHolder.addSoftConstraintMatch(kcontext, - $config.getMinDaysBetweenGuardias().getSoftScore());
end

rule "Avoid consecutive Tardes"
    when
        $config : GuardianesConstraintConfiguration()
        $d : Doctor()
        $a1 : ShiftAssignment(doctor == $d, shift.shiftType == "TARDE", $date1 : dayConfiguration.date)
        $a2 : ShiftAssignment(doctor == $d, shift.shiftType == "TARDE", $date2 : dayConfiguration.date, this != $a1)
        eval(Math.abs(ChronoUnit.DAYS.between($date1, $date2)) == 1)
    then
        scoreHolder.addSoftConstraintMatch(kcontext, - $config.getAvoidConsecutiveTardes().getSoftScore());
end